#!/usr/bin/env python3
"""
MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€å…¥å£
é›†æˆæ‰€æœ‰æœ€ä½³ç‰¹æ€§çš„ç»Ÿä¸€ç‰ˆæœ¬
"""

import asyncio
import sys
from pathlib import Path
import argparse

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))

from src.config.unified_config import load_unified_config, save_config_template
from src.core.summary_engine import SummaryEngine
from src.core.backend_manager import BackendManager


def create_parser() -> argparse.ArgumentParser:
    """åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°è§£æå™¨"""
    parser = argparse.ArgumentParser(
        description="MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€ç‰ˆæœ¬",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹ç”¨æ³•:
  # ç”Ÿæˆé…ç½®æ¨¡æ¿
  mineru-summarizer --init-config

  # åŸºç¡€æ€»ç»“
  mineru-summarizer input_dir output.md

  # æŒ‡å®šå‹ç¼©çº§åˆ«å’Œé…ç½®
  mineru-summarizer input_dir output.md --compression 30 --config config.yaml

  # å¯ç”¨äºŒæ¬¡æ‰“ç£¨
  mineru-summarizer input_dir output.md --polish

  # æ¢å¤ä¸­æ–­çš„ä»»åŠ¡
  mineru-summarizer --resume session_id

  # ç®¡ç†æ£€æŸ¥ç‚¹
  mineru-summarizer --list-checkpoints
  mineru-summarizer --clean-checkpoints 7

ç‰¹æ€§:
  âœ… åŸºäºMarkdown headerçš„å¤§ç« èŠ‚åˆ†ç‰‡ (V3ç‰¹æ€§)
  âœ… æ”¯æŒLLM APIå’ŒClaude CLIåç«¯åˆ‡æ¢
  âœ… æ£€æŸ¥ç‚¹æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢é™æµä¸­æ–­
  âœ… å¯é€‰çš„äºŒæ¬¡æ‰“ç£¨åŠŸèƒ½
  âœ… æ™ºèƒ½è¿‡æ»¤æ— å…³ç« èŠ‚ (Referencesç­‰)
  âœ… ä¸“æœ‰æŠ€æœ¯åè¯ä¿æŠ¤
        """
    )
    
    # ä¸»è¦æ“ä½œå‚æ•°
    parser.add_argument("input_dir", nargs="?", type=Path, help="è¾“å…¥ç›®å½• (åŒ…å«full.md)")
    parser.add_argument("output_file", nargs="?", type=Path, help="è¾“å‡ºæ–‡ä»¶è·¯å¾„")
    
    # æ€»ç»“é…ç½®
    parser.add_argument("--compression", "-c", type=int, default=50, choices=[30, 50, 70],
                       help="å‹ç¼©çº§åˆ« (30=ç²¾ç®€, 50=æ ‡å‡†, 70=è¯¦ç»†)")
    parser.add_argument("--polish", action="store_true", help="å¯ç”¨äºŒæ¬¡æ‰“ç£¨")
    
    # é…ç½®å’Œåç«¯
    parser.add_argument("--config", type=Path, help="é…ç½®æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--backend", choices=["llm_api", "claude_cli"], help="å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šåç«¯")
    
    # æ£€æŸ¥ç‚¹ç®¡ç†
    parser.add_argument("--resume", type=str, help="æ¢å¤æŒ‡å®šä¼šè¯ID")
    parser.add_argument("--list-checkpoints", action="store_true", help="åˆ—å‡ºæ‰€æœ‰æ£€æŸ¥ç‚¹")
    parser.add_argument("--clean-checkpoints", type=int, metavar="DAYS", help="æ¸…ç†Nå¤©å‰çš„æ£€æŸ¥ç‚¹")
    
    # å·¥å…·åŠŸèƒ½
    parser.add_argument("--init-config", action="store_true", help="ç”Ÿæˆé…ç½®æ–‡ä»¶æ¨¡æ¿")
    parser.add_argument("--validate", action="store_true", help="éªŒè¯é…ç½®å’Œåç«¯")
    
    return parser


def print_banner():
    """æ‰“å°æ¨ªå¹…"""
    print("=" * 70)
    print("ğŸš€ MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€ç‰ˆæœ¬")
    print("=" * 70)
    print("âœ¨ ç‰¹æ€§: å¤§ç« èŠ‚åˆ†ç‰‡ + å¤šåç«¯ + æ£€æŸ¥ç‚¹æ¢å¤ + äºŒæ¬¡æ‰“ç£¨")
    print("")


async def main():
    """ä¸»å‡½æ•°"""
    parser = create_parser()
    args = parser.parse_args()
    
    print_banner()
    
    # å¤„ç†å·¥å…·åŠŸèƒ½
    if args.init_config:
        config_path = Path("mineru-config.yaml")
        save_config_template(config_path)
        print(f"âœ… é…ç½®æ¨¡æ¿å·²ç”Ÿæˆ: {config_path}")
        print("è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶åä½¿ç”¨ --config å‚æ•°æŒ‡å®š")
        return
    
    # åŠ è½½é…ç½®
    try:
        config = load_unified_config(args.config)
        
        # å¦‚æœæŒ‡å®šäº†åç«¯ï¼Œè¦†ç›–é…ç½®
        if args.backend:
            print(f"ğŸ”§ å¼ºåˆ¶ä½¿ç”¨åç«¯: {args.backend}")
            if args.backend == "llm_api":
                from src.config.unified_config import LLMAPIConfig
                config.backend = LLMAPIConfig()
            elif args.backend == "claude_cli":
                from src.config.unified_config import ClaudeCLIConfig
                config.backend = ClaudeCLIConfig()
        
        # å¦‚æœæŒ‡å®šäº†polishï¼Œè¦†ç›–é…ç½®
        if args.polish:
            config.polish.enabled = True
            print("âœ¨ å¯ç”¨äºŒæ¬¡æ‰“ç£¨")
        
    except Exception as e:
        print(f"âŒ é…ç½®åŠ è½½å¤±è´¥: {e}")
        print("ğŸ’¡ æç¤º: ä½¿ç”¨ --init-config ç”Ÿæˆé…ç½®æ¨¡æ¿")
        sys.exit(1)
    
    # éªŒè¯é…ç½®
    if args.validate:
        print("ğŸ” éªŒè¯é…ç½®...")
        if BackendManager.validate_backend(config):
            print("âœ… é…ç½®éªŒè¯é€šè¿‡")
        else:
            print("âŒ é…ç½®éªŒè¯å¤±è´¥")
            sys.exit(1)
        return
    
    # åˆ›å»ºæ€»ç»“å¼•æ“
    engine = SummaryEngine(config)
    
    # å¤„ç†æ£€æŸ¥ç‚¹ç®¡ç†
    if args.list_checkpoints:
        engine.list_checkpoints()
        return
    
    if args.clean_checkpoints is not None:
        engine.clean_checkpoints(args.clean_checkpoints)
        return
    
    # å¤„ç†æ¢å¤ä»»åŠ¡
    if args.resume:
        print(f"ğŸ”„ æ¢å¤ä¼šè¯: {args.resume}")
        try:
            await engine.summarize(
                input_dir=Path("."),  # å ä½ç¬¦
                output_path=Path("."),  # å ä½ç¬¦
                resume_session=args.resume
            )
        except Exception as e:
            print(f"âŒ æ¢å¤å¤±è´¥: {e}")
            sys.exit(1)
        return
    
    # å¤„ç†æ–°ä»»åŠ¡
    if not args.input_dir or not args.output_file:
        print("âŒ é”™è¯¯: éœ€è¦æä¾›è¾“å…¥ç›®å½•å’Œè¾“å‡ºæ–‡ä»¶")
        print("ğŸ’¡ ä½¿ç”¨ --help æŸ¥çœ‹è¯¦ç»†ç”¨æ³•")
        sys.exit(1)
    
    # éªŒè¯è¾“å…¥
    if not args.input_dir.exists():
        print(f"âŒ é”™è¯¯: è¾“å…¥ç›®å½•ä¸å­˜åœ¨: {args.input_dir}")
        sys.exit(1)
    
    full_md_path = args.input_dir / "full.md"
    if not full_md_path.exists():
        print(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°full.mdæ–‡ä»¶: {full_md_path}")
        sys.exit(1)
    
    # éªŒè¯åç«¯
    if not BackendManager.validate_backend(config):
        print("âŒ åç«¯éªŒè¯å¤±è´¥")
        sys.exit(1)
    
    # æ‰§è¡Œæ€»ç»“ä»»åŠ¡
    try:
        await engine.summarize(
            input_dir=args.input_dir,
            output_path=args.output_file,
            compression_level=args.compression
        )
        
        print(f"\nğŸ‰ ä»»åŠ¡å®Œæˆ!")
        print(f"ğŸ“„ è¾“å‡ºæ–‡ä»¶: {args.output_file}")
        
        if config.processing.enable_checkpoint:
            print(f"ğŸ’¡ æç¤º: å¦‚æœä»»åŠ¡è¢«ä¸­æ–­ï¼Œä½¿ç”¨ --list-checkpoints æŸ¥çœ‹å¯æ¢å¤çš„ä¼šè¯")
        
    except KeyboardInterrupt:
        print(f"\nâ¸ï¸ ä»»åŠ¡è¢«ä¸­æ–­")
        if config.processing.enable_checkpoint:
            print("ğŸ’¾ è¿›åº¦å·²ä¿å­˜ï¼Œä½¿ç”¨ --list-checkpoints æŸ¥çœ‹æ£€æŸ¥ç‚¹")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


def sync_main():
    """åŒæ­¥å…¥å£ç‚¹"""
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nğŸ‘‹ å†è§!")
        sys.exit(0)


if __name__ == "__main__":
    sync_main()