#!/usr/bin/env python3
"""
MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€å…¥å£
é›†æˆæ‰€æœ‰æœ€ä½³ç‰¹æ€§çš„ç»Ÿä¸€ç‰ˆæœ¬
"""

import asyncio
import sys
from pathlib import Path
import argparse

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°Pythonè·¯å¾„
sys.path.insert(0, str(Path(__file__).parent))

from src.config.unified_config import load_unified_config, save_config_template
from src.core.summary_engine import SummaryEngine
from src.core.backend_manager import BackendManager
from src.core.document_parser import DocumentParser
from src.core.image_uploader import ImageUploader


def create_parser() -> argparse.ArgumentParser:
    """åˆ›å»ºå‘½ä»¤è¡Œå‚æ•°è§£æå™¨"""
    parser = argparse.ArgumentParser(
        description="MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€ç‰ˆæœ¬",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ç¤ºä¾‹ç”¨æ³•:
  # ç”Ÿæˆé…ç½®æ¨¡æ¿
  mineru-summarizer --init-config

  # åŸºç¡€æ€»ç»“
  mineru-summarizer input_dir output.md

  # æŒ‡å®šå‹ç¼©çº§åˆ«å’Œé…ç½®
  mineru-summarizer input_dir output.md --compression 30 --config config.yaml

  # å¯ç”¨äºŒæ¬¡æ‰“ç£¨
  mineru-summarizer input_dir output.md --polish

  # å¯ç”¨Debugæ¨¡å¼ä¿å­˜æ‰€æœ‰pairs
  mineru-summarizer input_dir output.md --debug-pairs

  # æ¢å¤ä¸­æ–­çš„ä»»åŠ¡
  mineru-summarizer --resume session_id

  # ç®¡ç†æ£€æŸ¥ç‚¹
  mineru-summarizer --list-checkpoints
  mineru-summarizer --clean-checkpoints 7
  
  # Debugæ¨¡å¼ - æŸ¥çœ‹æ–‡æ¡£åˆ†ç‰‡
  mineru-summarizer input_dir --debug-chunks


ç‰¹æ€§:
  âœ… åŸºäºMarkdown headerçš„å¤§ç« èŠ‚åˆ†ç‰‡ (V3ç‰¹æ€§)
  âœ… æ”¯æŒLLM APIå’ŒClaude CLIåç«¯åˆ‡æ¢
  âœ… æ£€æŸ¥ç‚¹æ¢å¤æœºåˆ¶ï¼Œé˜²æ­¢é™æµä¸­æ–­
  âœ… å¯é€‰çš„äºŒæ¬¡æ‰“ç£¨åŠŸèƒ½
  âœ… æ™ºèƒ½è¿‡æ»¤æ— å…³ç« èŠ‚ (Referencesç­‰)
  âœ… ä¸“æœ‰æŠ€æœ¯åè¯ä¿æŠ¤
  âœ… Debugæ¨¡å¼ï¼šé¢„è§ˆæ–‡æ¡£åˆ†ç‰‡æ•ˆæœ
  âœ… Debugæ¨¡å¼ï¼šä¿å­˜æ‰€æœ‰(åŸæ–‡,æ€»ç»“)å¯¹ç”¨äºè¿½æº¯
  âœ… å›¾ç‰‡ä¸Šä¼ ï¼šæ ¹æ®é…ç½®è‡ªåŠ¨ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ°S3å¹¶æ›¿æ¢é“¾æ¥
        """
    )
    
    
    # é»˜è®¤çš„ä¸»è¦æ“ä½œå‚æ•°ï¼ˆä¸ºäº†å…¼å®¹æ€§ï¼Œé¿å…ä¸å­å‘½ä»¤å‚æ•°å†²çªï¼‰
    parser.add_argument("input_dir", nargs="?", type=Path, help="è¾“å…¥ç›®å½• (åŒ…å«full.md)")
    parser.add_argument("summary_output", nargs="?", type=Path, help="æ€»ç»“è¾“å‡ºæ–‡ä»¶è·¯å¾„")
    
    # æ€»ç»“é…ç½®
    parser.add_argument("--compression", "-c", type=int, default=50, choices=[30, 50, 70, 100],
                       help="å‹ç¼©çº§åˆ« (30=ç²¾ç®€, 50=æ ‡å‡†, 70=è¯¦ç»†, 100=ç¿»è¯‘)")
    parser.add_argument("--polish", action="store_true", help="å¯ç”¨äºŒæ¬¡æ‰“ç£¨")
    parser.add_argument("--debug-pairs", action="store_true", help="Debugæ¨¡å¼ï¼šä¿å­˜æ‰€æœ‰(åŸæ–‡,æ€»ç»“)å¯¹ï¼Œç”¨äºè¿½æº¯ç¿»è¯‘è¿‡ç¨‹")
    
    # å…¨å±€é…ç½®å’Œåç«¯å‚æ•°
    parser.add_argument("--config", type=Path, help="é…ç½®æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--backend", choices=["llm_api", "claude_cli"], help="å¼ºåˆ¶ä½¿ç”¨æŒ‡å®šåç«¯")
    
    # æ£€æŸ¥ç‚¹ç®¡ç†
    parser.add_argument("--resume", type=str, help="æ¢å¤æŒ‡å®šä¼šè¯ID")
    parser.add_argument("--list-checkpoints", action="store_true", help="åˆ—å‡ºæ‰€æœ‰æ£€æŸ¥ç‚¹")
    parser.add_argument("--clean-checkpoints", type=int, metavar="DAYS", help="æ¸…ç†Nå¤©å‰çš„æ£€æŸ¥ç‚¹")
    
    # å·¥å…·åŠŸèƒ½
    parser.add_argument("--init-config", action="store_true", help="ç”Ÿæˆé…ç½®æ–‡ä»¶æ¨¡æ¿")
    parser.add_argument("--validate", action="store_true", help="éªŒè¯é…ç½®å’Œåç«¯")
    parser.add_argument("--debug-chunks", action="store_true", help="Debugæ¨¡å¼ï¼šåªåˆ†ç‰‡æ–‡æ¡£ï¼Œè¾“å‡ºåˆ†ç‰‡å†…å®¹ï¼Œä¸è¿›è¡Œæ€»ç»“")
    
    return parser


def print_banner():
    """æ‰“å°æ¨ªå¹…"""
    print("=" * 70)
    print("ğŸš€ MinerUå†…å®¹æ€»ç»“å™¨ - ç»Ÿä¸€ç‰ˆæœ¬")
    print("=" * 70)
    print("âœ¨ ç‰¹æ€§: å¤§ç« èŠ‚åˆ†ç‰‡ + å¤šåç«¯ + æ£€æŸ¥ç‚¹æ¢å¤ + äºŒæ¬¡æ‰“ç£¨")
    print("")


async def debug_chunks(input_dir: Path, config):
    """Debugæ¨¡å¼ï¼šåªåˆ†ç‰‡æ–‡æ¡£å¹¶è¾“å‡ºæ¯ä¸ªåˆ†ç‰‡å†…å®¹"""
    print("ğŸ” Debugæ¨¡å¼ï¼šæ–‡æ¡£åˆ†ç‰‡è°ƒè¯•")
    print(f"ğŸ“‚ è¾“å…¥ç›®å½•: {input_dir}")
    
    # è§£ææ–‡æ¡£
    print("\nğŸ“š è§£æMarkdownæ–‡æ¡£...")
    full_md_path = input_dir / "full.md"
    parser = DocumentParser(config.processing.max_tokens_per_chapter)
    chapter_chunks = parser.parse_markdown_file(full_md_path)
    
    print(f"âœ… è§£æå®Œæˆï¼Œç”Ÿæˆ {len(chapter_chunks)} ä¸ªåˆ†ç‰‡")
    parser.print_statistics(chapter_chunks)
    
    # è¾“å‡ºæ¯ä¸ªåˆ†ç‰‡çš„è¯¦ç»†å†…å®¹
    print("\n" + "=" * 70)
    print("ğŸ“„ åˆ†ç‰‡å†…å®¹è¯¦æƒ…")
    print("=" * 70)
    
    for i, chunk in enumerate(chapter_chunks, 1):
        print(f"\nğŸ”– åˆ†ç‰‡ {i}: {chunk.id}")
        print(f"ğŸ“ æ ‡é¢˜: {chunk.chapter_title}")
        print(f"ğŸ“Š å±‚çº§: {chunk.chapter_level}")
        print(f"ğŸ”¢ Tokenæ•°: {chunk.token_count:,}")
        print(f"ğŸ“‹ å­ç« èŠ‚æ•°: {len(chunk.sub_sections)}")
        
        if chunk.sub_sections:
            print("ğŸ“š å­ç« èŠ‚:")
            for sub in chunk.sub_sections[:10]:  # æœ€å¤šæ˜¾ç¤º10ä¸ªå­ç« èŠ‚
                print(f"   â€¢ {sub}")
            if len(chunk.sub_sections) > 10:
                print(f"   ... è¿˜æœ‰ {len(chunk.sub_sections) - 10} ä¸ªå­ç« èŠ‚")
        
        print(f"\nğŸ“– å†…å®¹é¢„è§ˆ (å‰500å­—ç¬¦):")
        print("-" * 50)
        preview_content = chunk.content[:500]
        print(preview_content)
        if len(chunk.content) > 500:
            print("...")
            print(f"(å®Œæ•´å†…å®¹å…± {len(chunk.content)} å­—ç¬¦)")
        print("-" * 50)
        
        # é—®ç”¨æˆ·æ˜¯å¦è¦çœ‹å®Œæ•´å†…å®¹
        if len(chunk.content) > 500:
            user_input = input(f"\nğŸ’¡ æ˜¯å¦æŸ¥çœ‹å®Œæ•´å†…å®¹? (y/N): ").strip().lower()
            if user_input in ['y', 'yes']:
                print("\nğŸ“„ å®Œæ•´å†…å®¹:")
                print("=" * 50)
                print(chunk.content)
                print("=" * 50)
        
        # åœ¨æ¯ä¸ªåˆ†ç‰‡ä¹‹é—´æš‚åœï¼Œè®©ç”¨æˆ·å¯ä»¥ä»”ç»†æŸ¥çœ‹
        if i < len(chapter_chunks):
            user_input = input(f"\nâ¸ï¸ æŒ‰ Enter ç»§ç»­æŸ¥çœ‹ä¸‹ä¸€ä¸ªåˆ†ç‰‡ï¼Œæˆ–è¾“å…¥ 'q' é€€å‡º: ").strip().lower()
            if user_input == 'q':
                break
    
    print(f"\nğŸ‰ Debugå®Œæˆï¼æ€»å…±æ£€æŸ¥äº† {len(chapter_chunks)} ä¸ªåˆ†ç‰‡")
    print("ğŸ’¡ æç¤ºï¼šå¦‚æœåˆ†ç‰‡çœ‹èµ·æ¥æ­£ç¡®ï¼Œä½ å¯ä»¥è¿è¡Œæ­£å¸¸çš„æ€»ç»“å‘½ä»¤")


async def upload_images_if_enabled(config: 'UnifiedConfig', input_dir: Path, output_path: Path):
    """å¦‚æœé…ç½®å¯ç”¨ï¼Œåˆ™è‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡"""
    if not config.output.upload_images:
        return
        
    if not config.s3.enabled:
        print("âš ï¸ å›¾ç‰‡ä¸Šä¼ åŠŸèƒ½å·²å¯ç”¨ä½†S3é…ç½®æœªå¯ç”¨ï¼Œè·³è¿‡å›¾ç‰‡ä¸Šä¼ ")
        return
        
    print("\nğŸ–¼ï¸ å¼€å§‹ä¸Šä¼ å›¾ç‰‡...")
    
    try:
        from src.core.image_uploader import ImageUploader
        uploader = ImageUploader(config, dry_run=False)
        
        # è¯»å–è¾“å‡ºæ–‡ä»¶å†…å®¹
        with open(output_path, 'r', encoding='utf-8') as f:
            content = f.read()
        
        # ä½¿ç”¨è¾“å…¥ç›®å½•ä½œä¸ºåŸºå‡†ç›®å½•æ¥è§£æå›¾ç‰‡è·¯å¾„
        base_dir = input_dir
        processed_content, stats = uploader.process_markdown_content(content, base_dir)
        
        if stats['total'] > 0:
            # è¦†ç›–åŸæ–‡ä»¶
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(processed_content)
            
            print(f"ğŸ“Š å›¾ç‰‡ä¸Šä¼ ç»Ÿè®¡: æ€»è®¡ {stats['total']} ä¸ªå›¾ç‰‡")
            print(f"  âœ… æˆåŠŸä¸Šä¼ : {stats['uploaded']} ä¸ª")
            print(f"  â­ï¸ è·³è¿‡: {stats['skipped']} ä¸ª")
            print(f"  âŒ é”™è¯¯: {stats['errors']} ä¸ª")
            
            if stats['errors'] > 0:
                print("âš ï¸ éƒ¨åˆ†å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®å’Œç½‘ç»œ")
        else:
            print("ğŸ“„ æœªæ‰¾åˆ°æœ¬åœ°å›¾ç‰‡å¼•ç”¨")
            
    except ImportError:
        print("âŒ ç¼ºå°‘å›¾ç‰‡ä¸Šä¼ ä¾èµ–: è¯·å®‰è£… oss2")
        print("ğŸ’¡ è¿è¡Œ: pip install oss2")
    except Exception as e:
        print(f"âš ï¸ å›¾ç‰‡ä¸Šä¼ å¤±è´¥: {e}")
        print("ğŸ’¡ æç¤º: å¯é€šè¿‡è®¾ç½® output.upload_images: false ç¦ç”¨æ­¤åŠŸèƒ½")


async def main():
    """ä¸»å‡½æ•°"""
    parser = create_parser()
    args = parser.parse_args()
    
    print_banner()
    
    
    # å¤„ç†å·¥å…·åŠŸèƒ½
    if args.init_config:
        config_path = Path("mineru-config.yaml")
        save_config_template(config_path)
        print(f"âœ… é…ç½®æ¨¡æ¿å·²ç”Ÿæˆ: {config_path}")
        print("è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶åä½¿ç”¨ --config å‚æ•°æŒ‡å®š")
        return
    
    # åŠ è½½é…ç½®
    try:
        config = load_unified_config(args.config)
        
        # å¦‚æœæŒ‡å®šäº†åç«¯ï¼Œè¦†ç›–é…ç½®
        if args.backend:
            print(f"ğŸ”§ å¼ºåˆ¶ä½¿ç”¨åç«¯: {args.backend}")
            if args.backend == "llm_api":
                from src.config.unified_config import LLMAPIConfig
                config.backend = LLMAPIConfig()
            elif args.backend == "claude_cli":
                from src.config.unified_config import ClaudeCLIConfig
                config.backend = ClaudeCLIConfig()
        
        # å¦‚æœæŒ‡å®šäº†polishï¼Œè¦†ç›–é…ç½®
        if args.polish:
            config.polish.enabled = True
            print("âœ¨ å¯ç”¨äºŒæ¬¡æ‰“ç£¨")
        
        # å¦‚æœæŒ‡å®šäº†debug-pairsï¼Œè®¾ç½®æ ‡å¿—
        debug_pairs_enabled = args.debug_pairs
        if debug_pairs_enabled:
            print("ğŸ” å¯ç”¨Debugæ¨¡å¼ï¼šå°†ä¿å­˜æ‰€æœ‰(åŸæ–‡,æ€»ç»“)å¯¹")
        
    except Exception as e:
        print(f"âŒ é…ç½®åŠ è½½å¤±è´¥: {e}")
        print("ğŸ’¡ æç¤º: ä½¿ç”¨ --init-config ç”Ÿæˆé…ç½®æ¨¡æ¿")
        sys.exit(1)
    
    # éªŒè¯é…ç½®
    if args.validate:
        print("ğŸ” éªŒè¯é…ç½®...")
        if BackendManager.validate_backend(config):
            print("âœ… é…ç½®éªŒè¯é€šè¿‡")
        else:
            print("âŒ é…ç½®éªŒè¯å¤±è´¥")
            sys.exit(1)
        return
    
    # å¤„ç†Debugæ¨¡å¼
    if args.debug_chunks:
        if not args.input_dir:
            print("âŒ é”™è¯¯: Debugæ¨¡å¼éœ€è¦æä¾›è¾“å…¥ç›®å½•")
            print("ğŸ’¡ ä½¿ç”¨: mineru-summarizer input_dir --debug-chunks")
            sys.exit(1)
        
        # éªŒè¯è¾“å…¥
        if not args.input_dir.exists():
            print(f"âŒ é”™è¯¯: è¾“å…¥ç›®å½•ä¸å­˜åœ¨: {args.input_dir}")
            sys.exit(1)
        
        full_md_path = args.input_dir / "full.md"
        if not full_md_path.exists():
            print(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°full.mdæ–‡ä»¶: {full_md_path}")
            sys.exit(1)
        
        await debug_chunks(args.input_dir, config)
        return
    
    # åˆ›å»ºæ€»ç»“å¼•æ“
    engine = SummaryEngine(config)
    
    # å¤„ç†æ£€æŸ¥ç‚¹ç®¡ç†
    if args.list_checkpoints:
        engine.list_checkpoints()
        return
    
    if args.clean_checkpoints is not None:
        engine.clean_checkpoints(args.clean_checkpoints)
        return
    
    # å¤„ç†æ¢å¤ä»»åŠ¡
    if args.resume:
        print(f"ğŸ”„ æ¢å¤ä¼šè¯: {args.resume}")
        try:
            await engine.summarize(
                input_dir=Path("."),  # å ä½ç¬¦
                output_path=Path("."),  # å ä½ç¬¦
                resume_session=args.resume
            )
        except Exception as e:
            print(f"âŒ æ¢å¤å¤±è´¥: {e}")
            sys.exit(1)
        return
    
    # å¤„ç†æ–°ä»»åŠ¡
    if not args.input_dir or not args.summary_output:
        print("âŒ é”™è¯¯: éœ€è¦æä¾›è¾“å…¥ç›®å½•å’Œè¾“å‡ºæ–‡ä»¶")
        print("ğŸ’¡ ä½¿ç”¨ --help æŸ¥çœ‹è¯¦ç»†ç”¨æ³•")
        sys.exit(1)
    
    # éªŒè¯è¾“å…¥
    if not args.input_dir.exists():
        print(f"âŒ é”™è¯¯: è¾“å…¥ç›®å½•ä¸å­˜åœ¨: {args.input_dir}")
        sys.exit(1)
    
    full_md_path = args.input_dir / "full.md"
    if not full_md_path.exists():
        print(f"âŒ é”™è¯¯: æœªæ‰¾åˆ°full.mdæ–‡ä»¶: {full_md_path}")
        sys.exit(1)
    
    # éªŒè¯åç«¯
    if not BackendManager.validate_backend(config):
        print("âŒ åç«¯éªŒè¯å¤±è´¥")
        sys.exit(1)
    
    # æ‰§è¡Œæ€»ç»“ä»»åŠ¡
    try:
        await engine.summarize(
            input_dir=args.input_dir,
            output_path=args.summary_output,
            compression_level=args.compression,
            debug_pairs=debug_pairs_enabled
        )
        
        # è‡ªåŠ¨ä¸Šä¼ å›¾ç‰‡ï¼ˆå¦‚æœé…ç½®å¯ç”¨ï¼‰
        await upload_images_if_enabled(config, args.input_dir, args.summary_output)
        
        print(f"\nğŸ‰ ä»»åŠ¡å®Œæˆ!")
        print(f"ğŸ“„ è¾“å‡ºæ–‡ä»¶: {args.summary_output}")
        
        if config.processing.enable_checkpoint:
            print(f"ğŸ’¡ æç¤º: å¦‚æœä»»åŠ¡è¢«ä¸­æ–­ï¼Œä½¿ç”¨ --list-checkpoints æŸ¥çœ‹å¯æ¢å¤çš„ä¼šè¯")
        
    except KeyboardInterrupt:
        print(f"\nâ¸ï¸ ä»»åŠ¡è¢«ä¸­æ–­")
        if config.processing.enable_checkpoint:
            print("ğŸ’¾ è¿›åº¦å·²ä¿å­˜ï¼Œä½¿ç”¨ --list-checkpoints æŸ¥çœ‹æ£€æŸ¥ç‚¹")
        sys.exit(1)
    except Exception as e:
        print(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


def sync_main():
    """åŒæ­¥å…¥å£ç‚¹"""
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nğŸ‘‹ å†è§!")
        sys.exit(0)


if __name__ == "__main__":
    sync_main()